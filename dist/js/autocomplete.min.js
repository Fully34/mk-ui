!function(t,e){if("function"==typeof define&&define.amd)define(["mk"],function(i){return e(t,i)});else{if("object"!=typeof module||!module.exports)return e(t,t.Mk);module.exports=e(t,require("mk"))}}("undefined"!=typeof window?window:this,function(t,e){return e.create("Autocomplete",e.Selectmenu,{name:"mk-ac",templates:{shadow:'<div class="{{$key}}-shadow">\t\t\t\t\t{{template:tags}}\t\t\t\t\t{{template:trigger}}\t\t\t\t\t{{template:notifications}}\t\t\t\t\t{{scope:list}}{{template:list}}{{/scope:list}}\t\t\t\t</div>',tags:'<ul class="{{$key}}-tags" aria-label="Current selections"></ul>',tag:'<li class="{{$key}}-tag" role="presentation" data-value="{{value}}">\t\t\t\t\t<a href="javascript:void(0);" \t\t\t\t\t\trole="button" \t\t\t\t\t\tdata-value="{{value}}" \t\t\t\t\t\tdata-action="remove" \t\t\t\t\t\taria-label="Remove {{label}}"></a>\t\t\t\t\t{{label}}\t\t\t\t</li>',trigger:'<div class="{{$key}}-trigger {{if:disabled}} disabled{{/if:disabled}}" \t\t\t\t\trole="combobox" \t\t\t\t\taria-haspopup="listbox">\t\t\t\t\t{{template:input}}\t\t\t\t\t{{template:live}}\t\t\t\t</div>',input:'<input type="text" \t\t\t\t\tclass="{{$key}}-input" \t\t\t\t\tautocomplete="off" \t\t\t\t\taria-autocomplete="list" \t\t\t\t\t{{if:disabled}}aria-disabled="true" disabled {{/if:disabled}}\t\t\t\t\t{{if:multiple}}aria-multiselectable="true" {{/if:multiple}}\t\t\t\t\tvalue="{{label}}" />',live:'<div class="{{$key}}-live sr-only" \t\t\t\t\taria-atomic="true" \t\t\t\t\taria-live="assertive">\t\t\t\t</div>',notifications:'<div class="{{$key}}-notifications" \t\t\t\t\taria-atomic="true" \t\t\t\t\taria-live="assertive">\t\t\t\t</div>',list:'<ul id="{{id}}" class="{{$key}}-list" role="listbox">\t\t\t\t\t{{loop:items}}{{template:item}}{{/loop:items}}\t\t\t\t</ul>',item:'<li class="{{$key}}-item" role="presentation">\t\t\t\t\t<a id="{{id}}" \t\t\t\t\t\tclass="{{$key}}-option" \t\t\t\t\t\trole="option" \t\t\t\t\t\thref="javascript: void(0);" \t\t\t\t\t\taria-selected="{{selected}}" \t\t\t\t\t\taria-disabled="{{disabled}}" \t\t\t\t\t\tdata-value="{{$value}}" \t\t\t\t\t\tdata-display="{{value}}">\t\t\t\t\t\t<span class="{{$key}}-label">\t\t\t\t\t\t\t{{highlight:label}}\t\t\t\t\t\t</span>\t\t\t\t\t\t{{if:alt}}\t\t\t\t\t\t\t<span class="{{$key}}-alt">{{alt}}</span>\t\t\t\t\t\t{{/if:alt}}\t\t\t\t\t</a>\t\t\t\t</li>'},formats:{loading:"Searching for {{query}}",loaded:"{{count}} results loaded for {{query}}",error:"Whoops, looks like we're having issues with {{highlight:query}}",empty:"No results found for {{highlight:query}}",capacity:"You've reached your tag limit"},get version(){return"v1.0.0"},get rootinput(){return this.node("",this.root)},get element(){return this.rootinput[0]},get tagroot(){return this.shadow.find(this.selector("tags"))},get tags(){return this.tagroot.find(this.selector("tag"))},get live(){return this.shadow.find(this.selector("live"))},get notifications(){return this.shadow.find(this.selector("notifications"))},get isLoading(){return this.shadow.hasClass("loading")},get limit(){return this.config.limit},get doubledelete(){return this.config.doubledelete},get multiple(){return this.limit>1},get capacity(){return this.selections.length>=this.limit},get anything(){return this.config.anything},get value(){return this.selections.length>0?this.multiple?this.flatten(this.selections):this.flatten(this.selections[0]):null},get isEmpty(){return this.items.length<1},deletecount:0,selections:null,requests:0,cache:null,query:"",_verifyTag:function(t){var e=this.node("",t);if(e.length<1||"input"!==e[0].tagName.toLowerCase())throw new Error(":: Mk.Autocomplete - root must have a text <input> node ::");return!0},_define:function(t,e){this.query="",this.selections=[],this.requests=0,this.cache={},this.super(t,e)},_config:function(t,e){t=t||{};var i=this.rootinput;t.data=t.data||null,this._param("remote","string",t,null,i)._param("type","string",t,"json",i)._param("limit","number",t,1,i)._param("time","number",t,500,i)._param("doubledelete","boolean",t,t.limit>1,i)._param("anything","boolean",t,!0,i)._param("comma","boolean",t,!1,i)._param("notags","boolean",t,!1,i),e!==!0&&this.super(t)},_build:function(){this.super(),this.input.attr("placeholder",this.rootinput.attr("placeholder")),this.updateTagroot()},_bind:function(){this._bindInputEvents(),this._bindListEvents(),this._bindLabelEvents()},_bindInputEvents:function(){var t=this,e=this.trigger;this.input.on("focus.mk",function(t){e.addClass("focus")}).on("blur.mk",function(i){e.removeClass("focus"),t.hide(),this.disabled||t.blur()}).on("keydown.mk",function(e){t._keydown(e)}).on("keyup.mk",function(e){t._keyup(e)})},_bindLabelEvents:function(){var t=this;this.tagroot.on("click.mk",'[data-action="remove"]',function(e){e.preventDefault(),t.deselect(this.getAttribute("data-value"))})},_keyup:function(t){var e=t.which,i=this.keyIsBehavior(e);if(i>-1)return void(1===i&&t.preventDefault());var s=this.input.val();return e!==this.keycode.backspace||s?(this.doubledelete=!1,e===this.keycode.comma&&this.anything&&this.config.comma?this.comma(s):void this.search(s)):this.popByDelete().abort().clear()},_enter:function(t){t.preventDefault();var e=this.items.find(".active"),i=this.input.val();if(i&&e.length<1&&this.anything){var s=this.flatten({label:i,value:i});return this.abort().select(s)}return this.isHidden&&this.isEmpty!==!0?this.show():void this.super(t)},_render:function(t){var e=this.list,i=t.list.items;this.each(i,function(t,i){e.append(this.html("item",i))})},updateTagroot:function(){var t="removeClass",e="false";return this.config.notags&&(t="addClass",e="true"),this.shadow[t]("no-tags"),this.tagroot.attr("aria-hidden",e),this},popByDelete:function(){return this.doubledelete&&(this.deletecount>0?(this.deletecount=0,this.pop()):this.deletecount=1),this},move:function(t){if(this.isEmpty){if(!this.hasCache())return;this.search("")}if(this.isHidden)return void this.show();var e=this.items.find(".active")[0],i=this.index(e)+(t&&-1||1);return e||(i=0),i>=this.items.length&&(i=-1),i<0?(this.$(e).removeClass("active"),void this.input.attr("aria-activedescendant","").val(this.query)):void this.super(t)},buildOptionData:function(t,e){return t=t||[],this.each(t,function(t,i){i.$value=i.$value||this.flatten({value:i.value,label:i.label}),i.highlight=e||"",i.id=i.id||this.uid()}),t},data:function(t){t=t||this.getCache();var e=this.input.val();"string"==typeof t&&(e=t,t=this.getCache(t));var i=new RegExp(" "+this.name+" ","i"),s=" "+this.element.className+" ",n=this.shadow&&this.shadow.attr("id")||this.uid();return{classname:s.replace(i,""),multiple:this.multiple,disabled:this.disabled,list:{id:n,items:this.buildOptionData(t,e)}}},flatten:function(t){return t&&btoa(JSON.stringify(t))||""},unflatten:function(t){return t&&JSON.parse(atob(t))||{}},label:function(t){if("undefined"==typeof t)return this.input.val();var e=this.$(t),i=e.find(this.selector("label")).text(),s={node:e,label:i};return this.emit("create.label",s),s.label},filterData:function(t,e){var i,s=e;return t&&(s=[],i=new RegExp(t,"i"),this.each(e,function(t,e){(i.test(e.label)||i.test(e.value))&&s.push(e)})),s},hasCache:function(t){return t=(t||"").toLowerCase(),!(null!==this.config.remote||!this.config.data)||(!!this.cache.hasOwnProperty(t)||(!t&&null!==this.config.data||!1))},getCache:function(t){return t=(t||"").toLowerCase(),null===this.config.remote&&this.config.data?this.filterData(t,this.config.data):this.cache.hasOwnProperty(t)?this.cache[t]:!t&&this.config.data||null},setCache:function(t,e){return this.cache[(t||"").toLowerCase()]=e},pop:function(){if(this.selections.length>0){var t=this.selections.pop();return this.multiple&&this.input.val(t.value),this.abort().tag(t,!0),t}return null},comma:function(t){var e=t.split(/\,\s{0,}/),i=!0,s=!1;return this.each(e,function(t,e){e&&(i&&(this.abort(),i=!1),s=!0,this.select(this.flatten({label:e,value:e})))}),s&&(this.clear(),this.input.val("")),this},search:function(t,e){var i=t;return e===!0&&(i=(this.query||"")+t),this.query=i,this.hasCache(this.query)?void this.render(this.query,this.data(this.getCache(this.query))):this.query?void this.request(this.query):void 0},clear:function(){return this.items.remove(),this.live.text(""),this.hide(),this},show:function(){if(!this.isEmpty){var t=this.trigger,e=this.list;return this.disabled!==!0&&this.isHidden&&(this.transition(e,function(){e.addClass("in")}),this.delay(function(){t.attr("aria-expanded","true"),e.attr("aria-hidden","false"),this.emit("show")})),this}},select:function(t){var e=this.unflatten(t);return this.exists(e.value)!==!0&&(this.limit<2&&this.removeAll(),this.capacity?(this.notify(1),this.emit("capacity",this.selections)):(this.shadow.removeClass("capacity"),this.selections.push(e),this.tag(e).updateRoot().emit("change")),this.hide()),this},deselect:function(t){var e=this.unflatten(t),i=!1;return this.each(this.selections,function(t,s){if(s.value===e.value)return i=!0,-1}),i&&(this.notify(),this.tag(e,!0),this.updateRoot().emit("change")),this},exists:function(t){var e=!1;return this.each(this.selections,function(i,s){if(s.value===t)return e=!0,!1}),e},blur:function(){return this.abort().loading(!1),this},tag:function(t,e){var i=this.flatten(t),s={label:t.label,value:i,raw:t};return e?this.tags.filter('[data-value="'+i+'"]').remove():(this.emit("create.taglabel",s),this.tagroot.append(this.html("tag",s))),this},updateRoot:function(){return this.element.value=this.value,this},loading:function(t,e,i){var s=t&&"addClass"||"removeClass",n=t&&"loading"||"loaded",a={query:e,count:i};return this.live.text(""),(t&&e||e&&i)&&this.live.text(this.format(n,a)),this.shadow[s]("loading"),this},notify:function(t,e){var i={query:e},s=0===t&&"empty"||t===-1&&"error"||1===t&&"capacity"||"";return this.notifications.html(this.format(s,i)),this},removeAll:function(){if(this.selections.length>0){var t=this.selections.splice(0,this.selections.length);this.notify(),this.tags.remove(),this.emit("change",t)}return this},abort:function(){return this.timer&&(clearTimeout(this.timer),this.timer=null,this.requests-=1,this.loading(!1)),this},request:function(t){this.config.remote&&(this.abort(),this.timer=this.delay(function(){this.query=t,this.loading(!0,t),this.emit("request.before",t);var e=this.query,i=this.format(this.config.remote,{"%query":e}),s=this;$.ajax({url:i,type:"get",dataType:this.config.type,requestNumber:++this.requests,complete:function(t,i){this.requestNumber===s.requests&&s.complete(e,t,i)},error:function(t){this.requestNumber===s.requests&&s.error(e,t)},success:function(t,i,n){this.requestNumber===s.requests&&s.success(e,t,i,n)}})},this.config.time))},complete:function(t,e,i){this.emit("request.complete",t,e,i)},error:function(t,e){this.emit("request.error",t,e),this.render(t,null,-1)},success:function(t,e,i,s){this.emit("request.success",t,e,i,s),this.setCache(t,e),this.render(t,this.data(t))},render:function(t,e,i){return e=e||{},e.list=e.list||{},e.list.items=e.list.items||[],this.items.remove(),i===-1?(this.notify(i,t),this.hide()):e.list.items.length<1?(this.notify(0,t),this.hide()):(this.notify(),this.events.render&&this.events.render.length>0?this.emit("render",e):this._render(e),this.show()),this.loading(!1,t,e.list.items.length)},update:function(){this._config(this.config),this.super(),this.input.attr("placeholder",this.rootinput.attr("placeholder")),this.updateTagroot()}}),e.get("Autocomplete")});